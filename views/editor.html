<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

        <title>Editor di storie</title>
        <!-- BOOTSTRAP -->
        <link
            type="text/css"
            rel="stylesheet"
            href="//unpkg.com/bootstrap/dist/css/bootstrap.min.css"
        />
        <link
            type="text/css"
            rel="stylesheet"
            href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css"
        />
        <link
            type="text/css"
            rel="stylesheet"
            href="../public/stylesheets/editor.css"
        />
        <!-- Load polyfills to support older browsers -->
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver"></script>

        <!-- Required scripts -->
        <script src="//unpkg.com/vue@latest/dist/vue.js"></script>
        <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
        <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue-icons.min.js"></script>
    </head>
    <body>
        <div id="app">
            <!-- NAVBAR CON LOGO E TABS (STORIE, MISSIONI, ATTIVITà) -->
            <b-navbar sticky id="topbar" type="dark" class="py-0 px-0">
                <b-navbar-brand href="/" class="py-0 mx-5">
                    <img
                        src="../public/images/logo2.png"
                        alt="Logo"
                        height="46"
                    />
                </b-navbar-brand>
                <b-navbar-nav>
                    <b-nav-item
                        v-for="(item,index) in sections"
                        :key="index"
                        :class="{ active : (item === active_section) }"
                        @click="active_section = item"
                        class="py-2 px-4"
                    >
                        {{ item.navbar_name }}
                    </b-nav-item>
                </b-navbar-nav>
            </b-navbar>

            <!-- 
                CONTENUTO DELLA PAGINA
                varia a seconda della tab selezionata (active_section)
            -->
            <b-container fluid v-if="active_section">
                <b-row>
                    <b-col cols="auto" class="mr-auto ml-4">
                        <b-list-group class="tabs" horizontal>
                            <b-list-group-item
                                button
                                v-for="(item,index) in active_section.tabs"
                                :key="index"
                                class="px-2"
                                :class="{ active : item == active_section.tab_active }"
                                @click="active_section.tab_active = item"
                            >
                                <h3>{{ item }}</h3>
                            </b-list-group-item>
                        </b-list-group>
                    </b-col>
                    <b-col cols="4" class="my-2 px-0">
                        <b-input-group id="searchbar" class="px-1">
                            <b-input-group-prepend is-text>
                                <b-icon-search></b-icon-search>
                            </b-input-group-prepend>
                            <b-form-input
                                spellcheck="false"
                                type="search"
                                placeholder="Cerca..."
                                v-model="active_section.table_filter"
                            ></b-form-input>
                        </b-input-group>
                    </b-col>
                    <b-col cols="auto" class="my-2 mr-3 px-0">
                        <b-button
                            class="px-4"
                            @click="$bvModal.show('modal-add-new-element')"
                            >{{ active_section.add_new_placeholder }}</b-button
                        >
                        <add-new-element
                            :category="active_section.navbar_name"
                        ></add-new-element>
                    </b-col>
                </b-row>
                <b-row>
                    <b-col>
                        <b-table
                            borderless
                            hover
                            :busy="isBusy"
                            :filter="active_section.table_filter"
                            :filter-included-fields="filter_field"
                            :items="active_section.table_items"
                            :fields="active_section.table_fields"
                            tbody-tr-class="table-row"
                            thead-class="cell-default"
                        >
                            <template v-slot:cell(storyForHandicapped)="data">
                                <div
                                    v-if="storyForHandicappedContent(data)"
                                    class="cell-true"
                                >
                                    ✓
                                </div>
                                <div v-else class="cell-false">✗</div>
                            </template>
                            <template v-slot:cell(missionCompleted)="data">
                                <div
                                    v-if="missionCompletedContent(data)"
                                    class="cell-true"
                                >
                                    ✓
                                </div>
                                <div v-else class="cell-false">✗</div>
                            </template>
                            <template v-slot:cell(missionForHandicapped)="data">
                                <div
                                    v-if="missionForHandicappedContent(data)"
                                    class="cell-true"
                                >
                                    ✓
                                </div>
                                <div v-else class="cell-false">✗</div>
                            </template>
                            <template v-slot:cell(activityCompleted)="data">
                                <div
                                    v-if="activityCompletedContent(data)"
                                    class="cell-true"
                                >
                                    ✓
                                </div>
                                <div v-else class="cell-false">✗</div>
                            </template>
                            <template
                                v-slot:cell(activityForHandicapped)="data"
                            >
                                <div
                                    v-if="activityForHandicappedContent(data)"
                                    class="cell-true"
                                >
                                    ✓
                                </div>
                                <div v-else class="cell-false">✗</div>
                            </template>
                            <template v-slot:cell(actions)="data">
                                <b-button
                                    v-if="active_section == sections[0]"
                                    size="sm"
                                    style="background-color: #8f65fc"
                                    @click="onPublish(data)"
                                >
                                    <b-icon-play-fill></b-icon-play-fill>
                                </b-button>
                                <b-button
                                    v-if="active_section == sections[0]"
                                    size="sm"
                                    style="background-color: #003086"
                                    @click="onArchive(data)"
                                >
                                    <b-icon-archive-fill></b-icon-archive-fill>
                                </b-button>
                                <b-button
                                    size="sm"
                                    style="background-color: #ff3d4a"
                                    @click="onDelete(data,active_section.navbar_name)"
                                >
                                    <b-icon-trash-fill></b-icon-trash-fill>
                                </b-button>
                                <b-button
                                    size="sm"
                                    style="background-color: #00bec8"
                                    @click="onEdit(data)"
                                >
                                    <modal-edit-story
                                        v-if="active_section.navbar_name == 'Storie'"
                                        :story_to_edit="data.item"
                                        :missions="missions"
                                        :activities="activities"
                                    ></modal-edit-story>
                                    <modal-edit-mission
                                        v-if="active_section.navbar_name == 'Missioni'"
                                        :mission_to_edit="data.item"
                                        :activities="activities"
                                    ></modal-edit-mission>

                                    <modal-edit-activity
                                        v-if="active_section.navbar_name == 'Attività'"
                                        :activity_prop="data.item"
                                    ></modal-edit-activity>

                                    <b-icon-pencil-square></b-icon-pencil-square>
                                </b-button>
                                <b-button
                                    size="sm"
                                    style="background-color: #ffa300"
                                    @click="onClone(data,active_section.navbar_name)"
                                >
                                    <b-icon-back></b-icon-back>
                                </b-button>
                            </template>
                            <template v-slot:table-busy>
                                <div class="text-center text-danger my-2">
                                    <b-spinner class="align-middle"></b-spinner>
                                    <strong>Loading...</strong>
                                </div>
                            </template>
                        </b-table>
                    </b-col>
                </b-row>
            </b-container>
        </div>

        <template id="add-new-element">
            <b-modal
                size="lg"
                id="modal-add-new-element"
                title="Aggiungi nuovo elemento"
                @hide="onCancel()"
            >
                <template #default>
                    <b-container class="d-flex flex-column py-3 px-4" fluid>
                        <h5>Titolo</h5>
                        <b-form-input
                            class="mb-3"
                            type="text"
                            v-model="title"
                            maxlength=25
                            required
                            placeholder="Inserisci il titolo..."
                        ></b-form-input>
                        <div
                            class="d-flex flex-row justify-content-around my-2"
                            v-if="category == 'Storie'"
                        >
                            <div class="d-flex flex-column align-items-center">
                                <h5>Giocatore</h5>
                                <div class="d-flex justify-content-center">
                                    <b-form-checkbox
                                        class="m-2"
                                        v-model="singolo"
                                        >Singolo</b-form-checkbox
                                    >
                                    <b-form-checkbox
                                        class="m-2"
                                        v-model="gruppo"
                                        >Gruppo</b-form-checkbox
                                    >
                                    <b-form-checkbox
                                        class="m-2"
                                        v-model="classe"
                                        >Classe</b-form-checkbox
                                    >
                                </div>
                            </div>
                            <div class="d-flex flex-column align-items-center">
                                <h5>Età</h5>
                                <div class="d-flex justify-content-center">
                                    <b-form-checkbox class="m-2" v-model="sette"
                                        >7-10</b-form-checkbox
                                    >
                                    <b-form-checkbox
                                        class="m-2"
                                        v-model="undici"
                                        >11-14</b-form-checkbox
                                    >
                                    <b-form-checkbox
                                        class="m-2"
                                        v-model="quindici"
                                        >15-18</b-form-checkbox
                                    >
                                </div>
                            </div>
                        </div>
                    </b-container>
                </template>
                <template #modal-footer>
                    <b-row d-flex justify-content-end>
                        <b-button class="darker mx-1" @click="onCancel()">
                            Cancella
                        </b-button>
                        <b-button 	
                        class="darker mx-1" 	
                        v-on="validateCreateStory() ? { click: () => onSave() } : { click: () => showAlertModal() }"	
                        >	
                            Salva	
                        </b-button>	
                        <unvalid-alert	
                            :empty_title="title == ''"	
                            :invalid_story_type="!validateCreateStoryType()"	
                        >	
                        </unvalid-alert>
                    </b-row>
                </template>
            </b-modal>
        </template>

        <template id="modal-edit-story">
            <b-modal
                @ok="onSave()"
                @hide="onHide()"
                :id="story_to_edit.key"
                size="xl"
                :title="story_to_edit.title"
            >
                <template #modal-header>
                    <b-container
                        fluid
                        class="d-flex justify-content-between"
                        style="height: 100%"
                    >
                        <h4 class="py-3">{{ story_to_edit.title }}</h4>
                        <b-button
                            class="px-4 my-auto darker"
                            @click="showQrCode"
                            >QR CODE</b-button
                        >
                        <b-modal id="modal-qr-code" centered ok-only>
                            <template #modal-header>
                                <h4 class="mx-auto my-0">QR CODE</h4>
                            </template>
                            <template #default>
                                <b-container
                                    fluid
                                    class="d-flex justify-content-center"
                                >
                                    <a
                                        >http://192.168.178.21:8000/play?key={{story.key}}</a
                                    >
                                    <span
                                        v-if="story_to_edit.settings.published"
                                        class="py-3"
                                        id="qrcode"
                                    ></span>

                                    <p class="my-3" v-else>
                                        Pubblica la storia per visualizzare il
                                        QR code
                                    </p>
                                </b-container>
                            </template>
                            <template #modal-footer="{ close }">
                                <b-container
                                    fluid
                                    class="d-flex justify-content-end"
                                >
                                    <b-button class="darker" @click="close()">
                                        OK
                                    </b-button>
                                </b-container>
                            </template>
                        </b-modal>
                    </b-container>
                </template>
                <template #default>
                    <b-container fluid class="p-0 m-0" style="height: 100%">
                        <b-row class="p-0 m-0" style="height: 100%">
                            <b-col class="p-0 m-0 menu-column" cols="2">
                                <b-list-group>
                                    <b-list-group-item
                                        button
                                        v-for="(item,index) in list_item_edit_story"
                                        :key="index"
                                        @click="onEditStoryMenuClick(item)"
                                        :class="{ active : item.isActive }"
                                    >
                                        <h6 class="my-0">{{item.name}}</h6>
                                    </b-list-group-item>
                                </b-list-group>
                            </b-col>
                            <b-col
                                cols="10"
                                v-if="list_item_edit_story[0].isActive"
                            >
                                <b-row style="height: 54px">
                                    <b-col
                                        cols="auto"
                                        class="mr-auto ml-3 my-2 p-0"
                                    >
                                        <h3 class="m-0">Percorsi</h3>
                                    </b-col>
                                    <b-col cols="auto" class="my-2 mr-3 px-0">
                                        <b-button class="px-4" @click="addPath"
                                            >Nuovo Percorso</b-button
                                        >
                                    </b-col>
                                </b-row>
                                <b-row>
                                    <b-col
                                        class="mission-group-item scrollable px-3 py-3 m-0"
                                    >
                                        <b-list-group>
                                            <b-list-group-item
                                                v-for="(path,index) in story.paths"
                                                :key="index"
                                                class="my-2 d-flex align-items-center justify-content-between"
                                                :class="pathClass(path)"
                                                button
                                                @click="onPathClick(path)"
                                            >
                                                <div class="ml-2">
                                                    {{path.name}}
                                                </div>
                                                <div class="mr-2">
                                                    <b-button
                                                        @click="$bvModal.show(path.key)"
                                                    >
                                                        <b-icon
                                                            icon="pencil"
                                                        ></b-icon>
                                                    </b-button>
                                                    <b-button
                                                        @click="removePath(path)"
                                                    >
                                                        <b-icon
                                                            icon="x"
                                                        ></b-icon>
                                                    </b-button>
                                                    <modal-edit-path-name
                                                        :path="path"
                                                    ></modal-edit-path-name>
                                                </div>
                                            </b-list-group-item>
                                        </b-list-group>
                                    </b-col>
                                </b-row>
                            </b-col>
                            <b-col
                                cols="6"
                                v-if="list_item_edit_story[1].isActive"
                            >
                                <b-row class="m-0 p-0">
                                    <b-col cols="auto" class="mr-auto p-0 mt-2">
                                        <h3>Disponibili</h3>
                                    </b-col>
                                    <b-col cols="6" class="my-2 px-0">
                                        <b-input-group class="px-0">
                                            <b-form-input
                                                spellcheck="false"
                                                type="search"
                                                placeholder="Cerca"
                                                v-model="mission_filter"
                                            ></b-form-input>
                                        </b-input-group>
                                    </b-col>
                                </b-row>
                                <b-row>
                                    <b-col
                                        class="mission-group-item scrollable px-3 py-3 m-0"
                                    >
                                        <b-list-group>
                                            <b-list-group-item
                                                v-for="(mission,index) in availableFilteredMissions"
                                                :key="index"
                                                class="px-0 py-2 my-1"
                                                button
                                                @click="onAvailableMissionClick(mission)"
                                            >
                                                {{ mission.title }}
                                            </b-list-group-item>
                                        </b-list-group>
                                    </b-col>
                                </b-row>
                            </b-col>
                            <b-col
                                cols="4"
                                v-if="list_item_edit_story[1].isActive"
                            >
                                <b-row class="m-0 p-0">
                                    <b-col class="p-0 mt-2 mb-1">
                                        <h3 style="height: 34px">Aggiunte</h3>
                                    </b-col>
                                </b-row>
                                <b-row>
                                    <b-col
                                        class="mission-group-item scrollable px-3 py-3 m-0"
                                    >
                                        <h6
                                            v-if="selected_path.missions.length == 0"
                                        >
                                            Aggiungi qualche missione...
                                        </h6>
                                        <b-list-group v-else>
                                            <b-list-group-item
                                                v-for="(mission,index) in selected_path.missions"
                                                :key="index"
                                                class="py-2 px-3 my-1 d-flex justify-content-between align-items-center"
                                            >
                                                <div>{{ mission.title }}</div>
                                                <b-button
                                                    @click="removeMission(mission)"
                                                >
                                                    <b-icon icon="x"></b-icon>
                                                </b-button>
                                            </b-list-group-item>
                                        </b-list-group>
                                    </b-col>
                                </b-row>
                            </b-col>
                            <b-col
                                v-if="list_item_edit_story[2].isActive"
                                cols="3"
                            >
                                <b-row class="m-0 p-0">
                                    <b-col class="p-0 mt-2 mb-1">
                                        <h3 style="height: 34px">Missioni</h3>
                                    </b-col>
                                </b-row>
                                <b-row>
                                    <b-col
                                        class="mission-group-item scrollable px-3 py-3 m-0"
                                    >
                                        <h6
                                            v-if="selected_path.missions.length == 0"
                                        >
                                            Aggiungi qualche missione...
                                        </h6>
                                        <b-list-group v-else>
                                            <b-list-group-item
                                                v-for="(mission,index) in selected_path.missions"
                                                :key="index"
                                                class="px-0 py-2 my-1"
                                                button
                                                @click="showMissionInfos(mission)"
                                            >
                                                {{ mission.title }}
                                            </b-list-group-item>
                                        </b-list-group>
                                    </b-col>
                                </b-row>
                            </b-col>
                            <b-col
                                v-if="list_item_edit_story[2].isActive"
                                cols="7"
                                style="overflow-y: auto; height: 100%"
                            >
                                <h6 v-if="!selected_mission">
                                    Nessuna missione selezionata
                                </h6>
                                <div
                                    v-else
                                    class="d-flex flex-column"
                                    style="width: 100%; height: 100%"
                                >
                                    <h3 class="my-3">
                                        {{ selected_mission.title }}
                                    </h3>
                                    <h5 class="my-3">
                                        Numero di attività: {{
                                        selected_mission.activities.length }}
                                    </h5>
                                    <div
                                        class="d-flex justify-content-between align-items-center my-3"
                                    >
                                        <h5>Esiti</h5>
                                        <b-button @click="addResult()"
                                            >+ Aggiungi esito</b-button
                                        >
                                    </div>
                                    <b-list-group class="mission-group-item">
                                        <b-list-group-item
                                            class="my-2 py-2"
                                            v-for="(result,index) in selected_mission.results"
                                            :key="index"
                                        >
                                            <b-row
                                                style="width: 100%"
                                                class="m-0"
                                            >
                                                <b-col
                                                    cols="6"
                                                    class="p-0 d-flex align-items-center mr-auto"
                                                >
                                                    da {{ rangeMin(index) }}
                                                    punti a {{ rangeMax(index)
                                                    }} punti
                                                </b-col>
                                                <b-col
                                                    cols="6"
                                                    class="p-0 d-flex"
                                                >
                                                    <b-form-select
                                                        text-field="title"
                                                        value-field="key"
                                                        v-model="selected_mission.results[index].key"
                                                        :options="resultsSelect"
                                                    >
                                                    </b-form-select>
                                                    <b-button
                                                        @click="removeResult(result)"
                                                        class="ml-2"
                                                        ><b-icon
                                                            icon="x"
                                                        ></b-icon
                                                    ></b-button>
                                                </b-col>
                                            </b-row>
                                        </b-list-group-item>
                                    </b-list-group>
                                </div>
                            </b-col>
                            <b-col
                                class="m-0 p-0 scrollable-full-body-height"
                                v-if="list_item_edit_story[3].isActive"
                                cols="10"
                            >
                                <b-container class="d-flex flex-column" fluid>
                                    <div
                                        class="m-4 d-flex flex-column align-items-center"
                                    >
                                        <h5>Titolo</h5>
                                        <b-form-input
                                            style="width: 50%"
                                            class="m-2"
                                            type="text"
                                            maxlength=25
                                            v-model="selected_path.name"
                                            placeholder="Inserisci il titolo..."
                                        ></b-form-input>
                                        <h5>Missione d'inizio</h5>
                                        <b-form-select
                                            style="width: 50%"
                                            text-field="title"
                                            value-field="key"
                                            v-model="selected_path.first_mission"
                                            :options="selected_path.missions"
                                        >
                                        </b-form-select>
                                    </div>
                                </b-container>
                            </b-col>
                            <b-col
                                class="m-0 p-0 scrollable-full-body-height"
                                v-if="list_item_edit_story[4].isActive"
                                cols="10"
                            >
                                <b-container class="d-flex flex-column" fluid>
                                    <div
                                        class="m-4 d-flex flex-column align-items-center"
                                    >
                                        <h5>Titolo</h5>
                                        <b-form-input
                                            style="width: 50%"
                                            class="m-2"
                                            type="text"
                                            v-model="story.title"
                                            maxlength=25
                                            required
                                            placeholder="Inserisci il titolo..."
                                        ></b-form-input>
                                    </div>
                                    <div
                                        class="m-4 d-flex flex-column align-items-center"
                                    >
                                        <h5>Giocatore</h5>
                                        <div
                                            class="d-flex justify-content-center"
                                        >
                                            <b-form-checkbox
                                                class="m-2"
                                                v-model="story.settings.player.single"
                                                >Singolo</b-form-checkbox
                                            >
                                            <b-form-checkbox
                                                class="m-2"
                                                v-model="story.settings.player.group"
                                                >Gruppo</b-form-checkbox
                                            >
                                            <b-form-checkbox
                                                class="m-2"
                                                v-model="story.settings.player.class"
                                                >Classe</b-form-checkbox
                                            >
                                        </div>
                                    </div>
                                    <div
                                        class="m-4 d-flex flex-column align-items-center"
                                    >
                                        <h5>Età</h5>
                                        <div
                                            class="d-flex justify-content-center"
                                        >
                                            <b-form-checkbox
                                                class="m-2"
                                                v-model="story.settings.player.sette"
                                                >7-10</b-form-checkbox
                                            >
                                            <b-form-checkbox
                                                class="m-2"
                                                v-model="story.settings.player.undici"
                                                >11-14</b-form-checkbox
                                            >
                                            <b-form-checkbox
                                                class="m-2"
                                                v-model="story.settings.player.quindici"
                                                >15-18</b-form-checkbox
                                            >
                                        </div>
                                    </div>
                                </b-container>
                            </b-col>
                        </b-row>
                    </b-container>
                </template>
                <template #modal-footer="{ hide, ok }">
                    <b-row d-flex justify-content-end>
                        <b-button class="darker mx-1" @click="hide()">
                            Indietro
                        </b-button>
                        <b-button
                            class="darker mx-1"
                            v-on="validateStory() ? { click: () => ok() } : { click: () => showAlertModal() }"
                        >
                            Salva
                        </b-button>
                        <unvalid-alert
                            :empty_title="story.title == ''"
                            :empty_paths="!validatePath()"
                            :empty_path_name="!validatePathsNames()"
                            :invalid_story_type="!validateStoryType()"
                            :empty_story_missions="!validateStoryMissions()"
                            :empty_first_mission="!validateStoryFirstMission()"
                            :empty_story_results="!validateStoryResults()"
                        >
                        </unvalid-alert>
                    </b-row>
                </template>
            </b-modal>
        </template>

        <template id="modal-edit-path-name-template">
            <b-modal
                @hide="onHide"
                @ok="onOk"
                title="Titolo del percorso"
                ok-only
                :id="path.key"
            >
                <b-container fluid>
                    <b-row>
                        <b-col class="py-3">
                            <b-form-input
                                v-model="pathName"
                                maxlength=25
                                placeholder="Nome del percorso"
                            ></b-form-input>
                        </b-col>
                    </b-row>
                </b-container>
            </b-modal>
        </template>

        <template id="modal-edit-mission-template">
            <b-modal
                @hide="onHide"
                @ok="onSave"
                size="xl"
                :id="mission_to_edit.key"
            >
                <template #modal-header>
                    <b-container fluid>
                        <h4 class="py-3">{{ mission_to_edit.title }}</h4>
                    </b-container>
                </template>
                <template #default>
                    <b-container fluid class="p-0">
                        <b-row class="m-0">
                            <b-col class="p-0 menu-column" cols="2">
                                <b-list-group>
                                    <b-list-group-item
                                        button
                                        v-for="(item,index) in list_item_edit_mission"
                                        :key="index"
                                        :class="{ active : item.isActive }"
                                        @click="onEditMenuClick(item)"
                                    >
                                        <h6 class="my-0">{{item.name}}</h6>
                                    </b-list-group-item>
                                </b-list-group>
                            </b-col>
                            <b-col
                                cols="6"
                                v-if="list_item_edit_mission[0].isActive"
                            >
                                <b-row class="m-0">
                                    <b-col cols="auto" class="mr-auto p-0 mt-2">
                                        <h3>Disponibili</h3>
                                    </b-col>
                                    <b-col cols="6" class="my-2 p-0">
                                        <b-input-group class="px-0">
                                            <b-form-input
                                                spellcheck="false"
                                                type="search"
                                                placeholder="Cerca"
                                                v-model="activity_filter"
                                            ></b-form-input>
                                        </b-input-group>
                                    </b-col>
                                </b-row>
                                <b-row>
                                    <b-col
                                        class="mission-group-item scrollable py-3"
                                    >
                                        <h6
                                            v-if="availableFilteredActivities.length == 0"
                                        >
                                            Nessuna attività disponibile...
                                        </h6>
                                        <b-list-group>
                                            <b-list-group-item
                                                v-for="(activity,index) in availableFilteredActivities"
                                                :key="index"
                                                class="py-2 my-1"
                                                button
                                                @click="onAvailableActivityClick(activity)"
                                                style="height: 53px"
                                            >
                                                {{ activity.title }}
                                            </b-list-group-item>
                                        </b-list-group>
                                    </b-col>
                                </b-row>
                            </b-col>
                            <b-col
                                cols="4"
                                v-if="list_item_edit_mission[0].isActive"
                            >
                                <b-row class="m-0">
                                    <b-col class="p-0 mt-2 mb-1">
                                        <h3 style="height: 34px">Aggiunte</h3>
                                    </b-col>
                                </b-row>
                                <b-row>
                                    <b-col
                                        class="mission-group-item scrollable py-3"
                                    >
                                        <h6
                                            v-if="mission.activities.length == 0"
                                        >
                                            Aggiungi qualche attività...
                                        </h6>
                                        <b-list-group v-else>
                                            <b-list-group-item
                                                v-for="(activity,index) in mission.activities"
                                                :key="index"
                                                class="py-2 px-3 my-1 d-flex justify-content-between align-items-center"
                                            >
                                                <div>{{ activity.title }}</div>
                                                <b-button
                                                    @click="removeActivity(activity)"
                                                >
                                                    <b-icon icon="x"></b-icon>
                                                </b-button>
                                            </b-list-group-item>
                                        </b-list-group>
                                    </b-col>
                                </b-row>
                            </b-col>
                            <b-col
                                v-if="list_item_edit_mission[1].isActive"
                                cols="3"
                            >
                                <b-row class="m-0">
                                    <b-col class="p-0 mt-2 mb-1">
                                        <h3 style="height: 34px">Attività</h3>
                                    </b-col>
                                </b-row>
                                <b-row>
                                    <b-col
                                        class="mission-group-item scrollable py-3"
                                    >
                                        <h6
                                            v-if="mission.activities.length == 0"
                                        >
                                            Aggiungi qualche attività...
                                        </h6>
                                        <b-list-group v-else>
                                            <b-list-group-item
                                                v-for="(activity,index) in mission.activities"
                                                :key="index"
                                                class="px-0 py-2 my-1"
                                                button
                                                @click="showActivityInfos(activity)"
                                            >
                                                {{ activity.title }}
                                            </b-list-group-item>
                                        </b-list-group>
                                    </b-col>
                                </b-row>
                            </b-col>
                            <b-col
                                v-if="list_item_edit_mission[1].isActive"
                                cols="7"
                            >
                                <b-row v-if="!selected_activity" class="m-0">
                                    <b-col class="p-0 mt-2 mb-1">
                                        <h3 style="height: 34px">
                                            Nessuna attività selezionata
                                        </h3>
                                    </b-col>
                                </b-row>
                                <b-row
                                    v-else
                                    class="p-0 scrollable-full-body-height"
                                >
                                    <b-col
                                        class="p-0 m-0 d-flex flex-column align-items-center mission-group-item"
                                    >
                                        <h3 class="p-0 mt-2 mb-1">
                                            {{ selected_activity.title }}
                                        </h3>
                                        <h5 class="pt-3">
                                            Collegamenti con le altre attività
                                        </h5>
                                        <b-row class="m-0" style="width: 100%">
                                            <b-col
                                                cols="4"
                                                offset="1"
                                                style="
                                                    background-color: #171926;
                                                    text-align: center;
                                                    border-radius: 10px;
                                                    box-shadow: 0 2px 0#00bd58;
                                                    outline: 0;
                                                "
                                            >
                                                <b-icon
                                                    icon="check"
                                                    class="h1 mt-2"
                                                    style="color: #00bd58"
                                                ></b-icon>
                                                <h3>Vai a</h3>
                                                <b-form-select
                                                    text-field="title"
                                                    value-field="key"
                                                    :options="mission.activities"
                                                    v-model="selected_activity.correct.key"
                                                ></b-form-select>
                                                <h3 class="mt-3">Ottieni</h3>
                                                <b-form-input
                                                    style="text-align: center"
                                                    class="my-3"
                                                    type="text"
                                                    placeholder="100"
                                                    v-model="selected_activity.correct.points"
                                                ></b-form-input>
                                                <h3 class="mb-3">punti</h3>
                                            </b-col>
                                            <b-col
                                                cols="4"
                                                offset="2"
                                                style="
                                                    background-color: #171926;
                                                    text-align: center;
                                                    border-radius: 10px;
                                                    box-shadow: 0 2px 0#FF3D4A;
                                                    outline: 0;
                                                "
                                            >
                                                <b-icon
                                                    icon="x"
                                                    class="h1 mt-2"
                                                    style="color: #ff3d4a"
                                                ></b-icon>
                                                <h3>Vai a</h3>
                                                <b-form-select
                                                    text-field="title"
                                                    value-field="key"
                                                    :options="mission.activities"
                                                    v-model="selected_activity.wrong.key"
                                                ></b-form-select>
                                                <h3 class="mt-3">Ottieni</h3>
                                                <b-form-input
                                                    style="text-align: center"
                                                    class="my-3"
                                                    type="text"
                                                    placeholder="100"
                                                    v-model="selected_activity.wrong.points"
                                                ></b-form-input>
                                                <h3 class="mb-3">punti</h3>
                                            </b-col>
                                        </b-row>
                                        <h5 class="pt-3">
                                            Elementi dell'attività
                                        </h5>
                                        <b-list-group-item
                                            v-for="(element,index) in selected_activity.elements"
                                            :key="index"
                                            class="px-0 py-2 my-1"
                                            style="width: 70%"
                                        >
                                            {{ element.type }}
                                        </b-list-group-item>
                                    </b-col>
                                </b-row>
                            </b-col>
                            <b-col
                                class="m-0 p-0 scrollable-full-body-height"
                                v-if="list_item_edit_mission[2].isActive"
                                cols="10"
                            >
                                <b-container class="d-flex flex-column" fluid>
                                    <div
                                        class="m-3 d-flex flex-column align-items-center"
                                    >
                                        <h5>Titolo</h5>
                                        <b-form-input
                                            style="width: 50%"
                                            class="m-2"
                                            type="text"
                                            v-model="mission.title"
                                            required
                                            maxlength=25
                                            placeholder="Inserisci il titolo..."
                                        ></b-form-input>
                                    </div>
                                    <div
                                        class="m-3 d-flex flex-column align-items-center"
                                    >
                                        <h5>Attività d'inizio</h5>
                                        <b-form-select
                                            style="width: 50%"
                                            text-field="title"
                                            value-field="key"
                                            :options="mission.activities"
                                            v-model="mission.first_activity"
                                        ></b-form-select>
                                    </div>
                                </b-container>
                            </b-col>
                        </b-row>
                    </b-container>
                </template>
                <template #modal-footer="{ hide, ok }">
                    <b-row d-flex justify-content-end>
                        <b-button class="darker mx-1" @click="hide()">
                            Indietro
                        </b-button>
                        <b-button
                            class="darker mx-1"
                            v-on="validatemission() ? { click: () => ok() } : { click: () => showAlertModal() }"
                        >
                            Salva
                        </b-button>
                        <unvalid-alert
                            :empty_title="mission.title == ''"
                            :empty_start_activity="mission.first_activity == null"
                            :empty_activity="mission.activities.length == 0"
                            :empty_connection="!connectionActivities()"
                        >
                        </unvalid-alert>
                    </b-row>
                </template>
            </b-modal>
        </template>

        <template id="modal-edit-activity">
            <b-modal
                @hide="onHide()"
                @ok="onSave()"
                size="xl"
                :id="activity_prop.key"
            >
                <template #modal-header>
                    <b-container fluid class="d-flex align-items-center">
                        <h4 class="py-3">{{ activity_prop.title }}</h4>
                    </b-container>
                </template>

                <template #default>
                    <b-container fluid class="p-0 m-0">
                        <b-row class="p-0 m-0">
                            <b-col class="p-0 m-0 menu-column" cols="2">
                                <b-list-group>
                                    <b-list-group-item
                                        button
                                        v-for="(item,index) in list_item_edit_activity"
                                        :key="index"
                                        @click="onEditMenuClick(item)"
                                        :class="{ active : item.isActive }"
                                    >
                                        <h6 class="my-0">{{item.name}}</h6>
                                    </b-list-group-item>
                                </b-list-group>
                            </b-col>
                            <b-col
                                cols="5"
                                v-if="list_item_edit_activity[0].isActive"
                            >
                                <h3
                                    style="height: 34px; margin-bottom: 12px"
                                    class="p-0 mt-2"
                                >
                                    Componenti
                                </h3>
                                <div class="scrollable p-0 m-0">
                                    <h5 class="my-2">Necessari</h5>
                                    <p>
                                        (obbligatorio uno e uno solo per
                                        attività)
                                    </p>
                                    <div
                                        class="d-flex flex-wrap mission-group-item pad"
                                    >
                                        <b-button
                                            v-for="(component,index) in components_special"
                                            :key="index"
                                            class="m-2 list-group-item"
                                            @click="onComponentClick(component)"
                                            :disabled="disableSpecial"
                                            :class="{ sele : ( checkSelected(component) )}"
                                            style="height: 75px; width: 130px"
                                        >
                                            {{ component.type }}
                                        </b-button>
                                    </div>
                                    <h5 class="my-2">Aggiuntivi</h5>
                                    <div
                                        class="d-flex flex-wrap mission-group-item"
                                    >
                                        <b-button
                                            v-for="(component,index) in components"
                                            :key="index"
                                            class="m-2 list-group-item"
                                            @click="onComponentClick(component)"
                                            :disabled="disableDefault"
                                            style="height: 75px; width: 130px"
                                        >
                                            {{ component.type }}
                                        </b-button>
                                    </div>
                                    <h5 class="my-2">Minigiochi</h5>
                                    <p>(per attività mono-componente)</p>
                                    <div
                                        class="d-flex flex-wrap mission-group-item"
                                    >
                                        <b-button
                                            v-for="(component,index) in minigames"
                                            :key="index"
                                            class="m-2 list-group-item"
                                            @click="onComponentClick(component)"
                                            :disabled="disableMinigames"
                                            style="height: 75px; width: 130px"
                                        >
                                            {{ component.type }}
                                        </b-button>
                                    </div>
                                </div>
                            </b-col>
                            <b-col
                                cols="5"
                                v-if="list_item_edit_activity[0].isActive"
                            >
                                <b-row class="m-0 p-0">
                                    <b-col
                                        cols="auto"
                                        class="p-0 mr-auto mt-2 mb-1"
                                    >
                                        <h3 style="height: 34px">Struttura</h3>
                                    </b-col>
                                    <b-col cols="auto" class="my-2 px-0">
                                        <b-button
                                            @click="$bvModal.show('activity-preview')"
                                        >
                                            Anteprima
                                        </b-button>
                                    </b-col>
                                    <b-modal
                                        id="activity-preview"
                                        size="md"
                                        scrollable
                                    >
                                        <b-container fluid>
                                            <b-row
                                                v-for="element in activity.elements"
                                            >
                                                ANTEPRIMA DA FARE
                                            </b-row>
                                        </b-container>
                                    </b-modal>
                                </b-row>
                                <b-row class="scrollable p-0 m-0">
                                    <b-container
                                        fluid
                                        class="d-flex flex-column align-items-center justify-content-center py-3 mission-group-item"
                                    >
                                        <b-list-group-item
                                            button
                                            v-for="(element,index) in activity.elements"
                                            :key="index"
                                            class="my-1 activity-button d-flex align-items-center justify-content-between"
                                            @click="openComponentModal(element)"
                                        >
                                            <span class="mr-auto ml-1">
                                                {{ element.type }}
                                            </span>
                                            <div>
                                                <b-button
                                                    v-if="element.type"
                                                    class="align-self-start mx-1"
                                                    @click="editComponent(element)"
                                                >
                                                    <b-icon-pencil></b-icon-pencil>
                                                </b-button>
                                                <b-button
                                                    class="red align-self-start mx-1"
                                                    @click="removeElement(element)"
                                                >
                                                    <b-icon-x></b-icon-x>
                                                </b-button>
                                            </div>
                                        </b-list-group-item>
                                        <b-list-group-item
                                            @click="addElement"
                                            class="my-1 activity-button d-flex align-items-center justify-content-center"
                                            button
                                            style="overflow: hidden"
                                            ><h2>+</h2>
                                        </b-list-group-item>
                                        <b-modal
                                            v-if="component_selected"
                                            id="edit-component-modal"
                                            size="lg"
                                            :title="component_selected.type"
                                            @ok="onSaveComponentModal()"
                                            @hide="onHideComponentModal()"
                                            @hidden="component_selected = null; disableSpecial"
                                            hide-footer
                                        >
                                            <template #default="{ hide, ok }">
                                                <b-container
                                                    class="my-3 d-flex flex-column justify-content-around"
                                                >
                                                    <!-- DOMANDA -->
                                                    <div
                                                        v-if=" component_selected.type == 'Domanda' "
                                                    >
                                                        <h5>Domanda</h5>
                                                        <b-form-input
                                                            class="mb-2"
                                                            type="text"
                                                            v-model="component_selected.question"
                                                            placeholder="Inserisci la domanda..."
                                                        ></b-form-input>
                                                        <h5>Risposte</h5>
                                                        <b-form-tags
                                                            placeholder="Risposte..."
                                                            v-model="component_selected.answers"
                                                        ></b-form-tags>
                                                    </div>

                                                    <!-- SCELTA MULTIPLA -->
                                                    <div
                                                        v-if=" component_selected.type == 'Scelta Multipla' "
                                                    >
                                                        <h5>Domanda</h5>
                                                        <p>
                                                            Per superare
                                                            l'attività sarà
                                                            richiesto di
                                                            selezionare una
                                                            delle 4 risposte
                                                        </p>
                                                        <b-form-input
                                                            class="mb-2"
                                                            type="text"
                                                            v-model="component_selected.question"
                                                            placeholder="Inserisci la domanda..."
                                                        ></b-form-input>
                                                        <h5>Risposte</h5>
                                                        <b-form-radio
                                                            class="my-1"
                                                            v-model="component_selected.correct_answer"
                                                            name="answers"
                                                            :value="component_selected.answers[0]"
                                                        >
                                                            <b-form-input
                                                                type="text"
                                                                v-model="component_selected.answers[0]"
                                                                placeholder="Risposta..."
                                                            ></b-form-input>
                                                        </b-form-radio>
                                                        <b-form-radio
                                                            class="my-1"
                                                            v-model="component_selected.correct_answer"
                                                            name="answers"
                                                            :value="component_selected.answers[1]"
                                                        >
                                                            <b-form-input
                                                                type="text"
                                                                v-model="component_selected.answers[1]"
                                                                placeholder="Risposta..."
                                                            ></b-form-input>
                                                        </b-form-radio>
                                                        <b-form-radio
                                                            class="my-1"
                                                            v-model="component_selected.correct_answer"
                                                            name="answers"
                                                            :value="component_selected.answers[2]"
                                                        >
                                                            <b-form-input
                                                                type="text"
                                                                v-model="component_selected.answers[2]"
                                                                placeholder="Risposta..."
                                                            ></b-form-input>
                                                        </b-form-radio>
                                                        <b-form-radio
                                                            class="my-1"
                                                            v-model="component_selected.correct_answer"
                                                            name="answers"
                                                            :value="component_selected.answers[3]"
                                                        >
                                                            <b-form-input
                                                                type="text"
                                                                v-model="component_selected.answers[3]"
                                                                placeholder="Risposta..."
                                                            ></b-form-input>
                                                        </b-form-radio>
                                                    </div>

                                                    <!-- FOTO -->
                                                    <div
                                                        v-if=" component_selected.type == 'Foto' "
                                                    >
                                                        <h5>Domanda</h5>
                                                        <p>
                                                            Sarà richiesto lo
                                                            scatto di una foto
                                                            come risposta alla
                                                            seguente domanda
                                                        </p>
                                                        <b-form-input
                                                            class="mb-2"
                                                            type="text"
                                                            v-model="component_selected.question"
                                                            placeholder="Inserisci la domanda..."
                                                        ></b-form-input>
                                                    </div>

                                                    <!-- TESTO -->
                                                    <div
                                                        v-if=" component_selected.type == 'Testo' "
                                                    >
                                                        <h5>Descrizione</h5>
                                                        <p>
                                                            Per superare questa
                                                            attività non sarà
                                                            richiesta nessuna
                                                            azione
                                                        </p>
                                                        <b-form-textarea
                                                            class="my-2"
                                                            v-model="component_selected.text"
                                                            placeholder="Inserisci il testo..."
                                                            no-resize
                                                            rows="5"
                                                        ></b-form-textarea>
                                                    </div>

                                                    <!-- COLLEGA -->
                                                    <div
                                                        v-if=" component_selected.type == 'Collega' "
                                                    >
                                                        <h5>Risposte</h5>
                                                        <p>
                                                            L'utente dovrà
                                                            ricollegare
                                                            correttamente tutte
                                                            le frasi, proposte
                                                            spezzate in ordine
                                                            casuale
                                                        </p>
                                                        <div
                                                            class="d-flex flex-row justify-content-around"
                                                        >
                                                            <b-form-input
                                                                class="m-1"
                                                                type="text"
                                                                v-model="component_selected.answers[0].first"
                                                                placeholder="Prima parte..."
                                                            ></b-form-input>
                                                            <b-form-input
                                                                class="m-1"
                                                                type="text"
                                                                v-model="component_selected.answers[0].second"
                                                                placeholder="Seconda parte..."
                                                            ></b-form-input>
                                                        </div>
                                                        <div
                                                            class="d-flex flex-row justify-content-around"
                                                        >
                                                            <b-form-input
                                                                class="m-1"
                                                                type="text"
                                                                v-model="component_selected.answers[1].first"
                                                                placeholder="Prima parte..."
                                                            ></b-form-input>
                                                            <b-form-input
                                                                class="m-1"
                                                                type="text"
                                                                v-model="component_selected.answers[1].second"
                                                                placeholder="Seconda parte..."
                                                            ></b-form-input>
                                                        </div>
                                                        <div
                                                            class="d-flex flex-row justify-content-around"
                                                        >
                                                            <b-form-input
                                                                class="m-1"
                                                                type="text"
                                                                v-model="component_selected.answers[2].first"
                                                                placeholder="Prima parte..."
                                                            ></b-form-input>
                                                            <b-form-input
                                                                class="m-1"
                                                                type="text"
                                                                v-model="component_selected.answers[2].second"
                                                                placeholder="Seconda parte..."
                                                            ></b-form-input>
                                                        </div>
                                                        <div
                                                            class="d-flex flex-row justify-content-around"
                                                        >
                                                            <b-form-input
                                                                class="m-1"
                                                                type="text"
                                                                v-model="component_selected.answers[3].first"
                                                                placeholder="Prima parte..."
                                                            ></b-form-input>
                                                            <b-form-input
                                                                class="m-1"
                                                                type="text"
                                                                v-model="component_selected.answers[3].second"
                                                                placeholder="Seconda parte..."
                                                            ></b-form-input>
                                                        </div>
                                                    </div>

                                                    <!-- DESCRIZIONE -->
                                                    <div
                                                        v-if=" component_selected.type == 'Descrizione' "
                                                    >
                                                        <h5>Descrizione</h5>
                                                        <b-form-textarea
                                                            class="my-2"
                                                            v-model="component_selected.text"
                                                            placeholder="Inserisci il testo..."
                                                            no-resize
                                                            rows="5"
                                                        ></b-form-textarea>
                                                    </div>

                                                    <!-- IMMAGINE -->
                                                    <div
                                                        v-if=" component_selected.type == 'Immagine' "
                                                    >
                                                        <h5>Immagine</h5>
                                                        <p>
                                                            La seguente immagine
                                                            sarà mostrata nella
                                                            schermata
                                                        </p>
                                                        <b-form-file
                                                            accept="image/*"
                                                            v-model="component_selected.text"
                                                            :state="Boolean(component_selected.text)"
                                                            placeholder="Seleziona foto..."
                                                        ></b-form-file>
                                                    </div>

                                                    <!-- VIDEO -->
                                                    <div
                                                        v-if=" component_selected.type == 'Video' "
                                                    >
                                                        <h5>Video</h5>
                                                        <p>
                                                            Il seguente video
                                                            sarà mostrato nella
                                                            schermata
                                                        </p>
                                                        <p>
                                                            E' richiesto l'URL
                                                            embedded
                                                        </p>
                                                        <b-form-input
                                                            class="mb-2"
                                                            type="text"
                                                            v-model="component_selected.text"
                                                            placeholder="Inserisci il titolo..."
                                                        ></b-form-input>
                                                    </div>

                                                    <!-- BOTTONI -->
                                                    <div
                                                        class="d-flex justify-content-end mt-3"
                                                    >
                                                        <b-button
                                                            class="darker mx-1"
                                                            @click="hide()"
                                                        >
                                                            Indietro
                                                        </b-button>
                                                        <b-button
                                                            class="darker mx-1"
                                                            v-on="validateComponent() ? { click: () => ok() } : { click: () => showAlertModal() }"
                                                        >
                                                            Salva
                                                        </b-button>
                                                    </div>
                                                    <unvalid-alert
                                                        v-if="component_selected"
                                                        :unvalid_component="!validateComponent()"
                                                    ></unvalid-alert>
                                                </b-container>
                                            </template>
                                        </b-modal>
                                    </b-container>
                                </b-row>
                            </b-col>

                            <b-col
                                class="m-0 p-0 scrollable-full-body-height"
                                v-if="list_item_edit_activity[1].isActive"
                                cols="10"
                            >
                                <b-container class="d-flex flex-column" fluid>
                                    <div
                                        class="m-4 d-flex flex-column align-items-center"
                                    >
                                        <h5>Titolo</h5>
                                        <b-form-input
                                            style="width: 50%"
                                            class="m-2"
                                            type="text"
                                            v-model="activity.title"
                                            maxlength=25
                                            placeholder="Inserisci il titolo..."
                                        ></b-form-input>
                                    </div>
                                    <div
                                        class="m-4 d-flex flex-column align-items-center"
                                    >
                                        <h5>Tempo stimato</h5>
                                        <p>in minuti</p>
                                        <b-form-input
                                            style="width: 50%"
                                            class="m-2"
                                            v-model="activity.time"
                                            type="number"
                                            placeholder="Inserisci un valore..."
                                        ></b-form-input>
                                    </div>
                                </b-container>
                            </b-col>
                        </b-row>
                    </b-container>
                </template>

                <template #modal-footer="{ hide, ok }">
                    <b-row d-flex justify-content-end>
                        <b-button class="darker mx-1" @click="hide()">
                            Indietro
                        </b-button>
                        <b-button
                            class="darker mx-1"
                            v-on="validate() ? { click: () => ok() } : { click: () => showAlertModal() }"
                        >
                            Salva
                        </b-button>
                        <unvalid-alert
                            v-if="!component_selected"
                            :empty_title="activity.title == ''"
                            :empty_time="activity.time == null"
                            :empty_element="!validateStructure()"
                            :missing_special="!disableSpecial"
                        >
                        </unvalid-alert>
                    </b-row>
                </template>
            </b-modal>
        </template>

        <template id="unvalid-alert">
            <b-modal id="non-valid" title="Attenzione">
                <b-container class="mt-2" fluid>
                    <h5>Sono stati trovati i seguenti errori:</h5>
                    <ul>
                        <li v-if="empty_title">
                            Il titolo non può essere vuoto
                        </li>
                        <li v-if="empty_time">Il tempo non può essere nullo</li>
                        <li v-if="empty_element">
                            Una o più elementi dell'attività sono incompleti
                        </li>
                        <li v-if="missing_special">
                            Seleziona un componente tra i necessari
                        </li>
                        <li v-if="empty_start_activity">
                            Manca l'attività iniziale
                        </li>
                        <li v-if="empty_activity">Nessuna attività aggiunta</li>
                        <li v-if="unvalid_component">
                            Controlla di aver riempito correttamente tutti i
                            campi
                        </li>
                        <li v-if="empty_paths">Inserisci almeno un percorso</li>
                        <li v-if="empty_connection">
                            Inserisci gli esiti delle attività
                        </li>
                        <li v-if="empty_path_name">
                            Inserisci un titolo ad ogni percorso
                        </li>
                        <li v-if="invalid_story_type">
                            Specifica il tipo di storia in Impostazioni Storia
                        </li>
                        <li v-if="empty_story_missions">
                            Inserisci almeno una missione in tutti i percorsi
                        </li>
                        <li v-if="empty_first_mission">
                            Specifica la missione iniziale in ogni percorso
                        </li>
                        <li v-if="empty_story_results">
                            Specifica un esito per ogni missione di ogni
                            percorso
                        </li>
                    </ul>
                </b-container>
            </b-modal>
        </template>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <!-- CUSTOM -->
        <script src="/public/javascripts/editor.js"></script>
        <script src="../public/javascripts/kjua-0.9.0.min.js"></script>
    </body>
</html>
